AmCharts.AmExport=AmCharts.Class({construct:function(t,e,o){this.DEBUG=!1,this.chart=t,this.canvas=null,this.svgs=[],this.userCFG=e,this.buttonIcon="export.png",this.exportPNG=!0,this.exportPDF=!1,this.exportJPG=!1,this.exportSVG=!1,this.right=0,this.top=0,this.buttonRollOverColor="#EFEFEF",this.textRollOverColor="#CC0000",this.buttonTitle="Save chart as an image",this.buttonAlpha=.75,this.imageFileName="amChart",this.imageBackgroundColor="#FFFFFF",o&&this.init()},toCoordinate:function(t){return void 0===t?"auto":-1!=String(t).indexOf("%")?t:t+"px"},init:function(){var t=this,e=[];t.exportPNG&&e.push("png"),t.exportPDF&&e.push("pdf"),t.exportJPG&&e.push("jpg"),t.exportSVG&&e.push("svg");var o=[];if(1==e.length){var r=e[0];o.push({format:r,iconTitle:t.buttonTitle,icon:t.chart.pathToImages+t.buttonIcon})}else if(e.length>1){for(var n=[],a=0;a<e.length;a++)n.push({format:e[a],title:e[a].toUpperCase()});o.push({onclick:function(){},icon:t.chart.pathToImages+t.buttonIcon,items:n})}var i=t.color;void 0===i&&(i=t.chart.color);var s=t.buttonColor;void 0===s&&(s="transparent"),t.cfg={menuTop:t.toCoordinate(t.top),menuLeft:t.toCoordinate(t.left),menuRight:t.toCoordinate(t.right),menuBottom:t.toCoordinate(t.bottom),menuItems:o,menuItemStyle:{backgroundColor:s,opacity:t.buttonAlpha,rollOverBackgroundColor:t.buttonRollOverColor,color:i,rollOverColor:t.textRollOverColor,paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:t.chart.fontFamily,fontSize:t.chart.fontSize+"px"},menuItemOutput:{backgroundColor:t.imageBackgroundColor,fileName:t.imageFileName,format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(t,e,o){o.preventDefault(),t.output(e)}},removeImagery:!0},t.processing={buffer:[],drawn:0,timer:0},void 0!==window.canvg&&void 0!==window.RGBColor&&(t.cfg.menuItemOutput.render="canvg"),void 0!==window.saveAs&&(t.cfg.menuItemOutput.output="save"),AmCharts.isIE&&AmCharts.IEversion<10&&(t.cfg.menuItemOutput.output="dataurlnewwindow");var l=t.userCFG;l&&(l.menuItemOutput=AmCharts.extend(t.cfg.menuItemOutput,l.menuItemOutput||{}),l.menuItemStyle=AmCharts.extend(t.cfg.menuItemStyle,l.menuItemStyle||{}),t.cfg=AmCharts.extend(t.cfg,l)),t.chart.AmExport=t,t.chart.addListener("rendered",function(){t.setup()}),t.DEBUG&&(window.AmExport=t)},log:function(){console.log("AmExport: ",arguments)},setup:function(){(!AmCharts.isIE||AmCharts.isIE&&AmCharts.IEversion>9)&&this.generateButtons()},generateBinaryArray:function(t){for(var e,o,r=t.length,n=new Uint8Array(r/4*3|0),a=0,i=0,s=[0,0],l=0,g=0,u=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);r--;)255!==(e=u[(o=t.charCodeAt(a++))-43])&&void 0!==e&&(s[1]=s[0],s[0]=o,g=g<<6|e,4===++l&&(n[i++]=g>>>16,61!==s[1]&&(n[i++]=g>>>8),61!==s[0]&&(n[i++]=g),l=0));return n},generateBlob:function(t,e){var o="image/svg+xml"!=e?t.indexOf(",")+1:0,r=t.substring(0,o),n=t,a=new Blob;return-1!=r.indexOf("base64")&&(n=this.generateBinaryArray(t.substring(o))),AmCharts.isIE&&AmCharts.IEversion<10?(a.data=n,a.size=n.length,a.type=e,a.encoding="base64"):a=new Blob([n],{type:e}),a},generatePDF:function(t){var e={output:function(){return""}},o=this.canvas.toDataURL("image/jpeg"),r=25.4*this.canvas.width/t.dpi,n=25.4*this.canvas.height/t.dpi;return window.jsPDF?(e=new jsPDF).addImage?e.addImage(o,"JPEG",0,0,r,n):alert("Missing jsPDF plugin; Please add the 'addImage' plugin."):alert("Missing jsPDF lib; Don't forget to add the addImage plugin."),e},output:function(t,e){var o=this;return t=AmCharts.extend(AmCharts.extend({},o.cfg.menuItemOutput),t||{}),o.chart.prepareForExport&&o.chart.prepareForExport(),o.generateOutput(t,function(){var r,n=null;"image/svg+xml"==t.format||"svg"==t.format?(n=o.generateSVG(),r=o.generateBlob(n,"image/svg+xml"),"save"==t.output?saveAs(r,t.fileName+".svg"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?r="data:image/svg+xml;base64,"+btoa(n):"dataurlnewwindow"==t.output?window.open("data:image/svg+xml;base64,"+btoa(n)):"datauri"==t.output||"dataurl"==t.output?location.href="data:image/svg+xml;base64,"+btoa(n):"datastream"==t.output&&(location.href="data:image/octet-stream;base64,"+n),e&&e.apply(o,[r])):"application/pdf"==t.format||"pdf"==t.format?(n=o.generatePDF(t).output("dataurlstring"),r=o.generateBlob(n,"application/pdf"),"save"==t.output?saveAs(r,t.fileName+".pdf"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?r=n:"dataurlnewwindow"==t.output?window.open(n):"datauri"==t.output||"dataurl"==t.output?location.href=n:"datastream"==t.output&&(location.href=n.replace("application/pdf","application/octet-stream")),e&&e.apply(o,[r])):"image/png"==t.format||"png"==t.format?(n=o.canvas.toDataURL("image/png"),r=o.generateBlob(n,"image/png"),"save"==t.output?saveAs(r,t.fileName+".png"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?r=n:"dataurlnewwindow"==t.output?window.open(n):"datauri"==t.output||"dataurl"==t.output?location.href=n:"datastream"==t.output&&(location.href=n.replace("image/png","image/octet-stream")),e&&e.apply(o,[r])):"image/jpeg"!=t.format&&"jpeg"!=t.format&&"jpg"!=t.format||(n=o.canvas.toDataURL("image/jpeg"),r=o.generateBlob(n,"image/jpeg"),"save"==t.output?saveAs(r,t.fileName+".jpg"):"datastring"==t.output||"datauristring"==t.output||"dataurlstring"==t.output?r=n:"dataurlnewwindow"==t.output?window.open(n):"datauri"==t.output||"dataurl"==t.output?location.href=n:"datastream"==t.output&&(location.href=n.replace("image/jpeg","image/octet-stream")),e&&e.apply(o,[r]))})},polifySVG:function(t){var e=this;function o(t,o){for(var r=t.getElementsByTagName(o),n=r.length;n--;)if(e.cfg.removeImagery)r[n].parentNode.removeChild(r[n]);else{var a=document.createElement("img"),i=document.createElement("canvas"),s=i.getContext("2d");i.width=r[n].getAttribute("width"),i.height=r[n].getAttribute("height"),a.src=r[n].getAttribute("xlink:href"),a.width=r[n].getAttribute("width"),a.height=r[n].getAttribute("height");try{s.drawImage(a,0,0,a.width,a.height),datastring=i.toDataURL()}catch(t){throw datastring=a.src,e.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!"),new Error(t)}r[n].setAttribute("xlink:href",datastring)}}return 0==AmCharts.IEversion&&(t.setAttribute("xmlns","http://www.w3.org/2000/svg"),e.cfg.removeImagery||t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink")),o(t,"pattern"),o(t,"image"),e.svgs.push(t),t},generateSVG:function(){var t=document.createElement("svg");t.setAttribute("xmlns","http://www.w3.org/2000/svg"),t.setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink");for(var e=0;e<this.processing.buffer.length;e++){var o=document.createElement("g"),r=this.processing.buffer[e];r[0].setAttribute("xmlns","http://www.w3.org/2000/svg"),r[0].setAttribute("xmlns:xlink","http://www.w3.org/1999/xlink"),o.setAttribute("transform","translate("+r[1].x+","+r[1].y+")"),o.appendChild(r[0]),t.appendChild(o)}return(new XMLSerializer).serializeToString(t)},generateOutput:function(t,e){for(var o=this,r=[],n=document.createElement("canvas"),a=n.getContext("2d"),i={y:0,x:0},s=o.chart.div.getElementsByTagName("svg"),l=0;l<s.length;l++)r.push(s[l]);o.chart.legend&&"outside"==o.chart.legend.position&&(o.chart.legend.container.container.externalLegend=!0,r.push(o.chart.legend.container.container),"left"==o.cfg.legendPosition?i.x=o.chart.legend.div.offsetWidth:"top"==o.cfg.legendPosition?i.y=o.chart.legend.div.offsetHeight:"object"==typeof o.cfg.legendPosition&&(i.y=o.cfg.legendPosition.chartTop,i.x=o.cfg.legendPosition.chartLeft)),o.processing.buffer=[],o.processing.drawn=0,o.canvas=n,o.svgs=[];var g={x:0,y:0};for(l=0;l<r.length;l++){var u=r[l].parentNode,d=Number(u.style.left.slice(0,-2)),c=Number(u.style.top.slice(0,-2)),p=o.polifySVG(r[l].cloneNode(!0)),h=AmCharts.extend({},i);r[l].externalLegend?"right"==o.cfg.legendPosition?(i.y=0,i.x=o.chart.divRealWidth):"bottom"==o.cfg.legendPosition?i.y=c||i.y:"object"==typeof o.cfg.legendPosition?(i.x=o.cfg.legendPosition.left,i.y=o.cfg.legendPosition.top):(i.x=0,i.y=0):"relative"==u.style.position?(i.x=d||i.x,i.y=c||i.y):(i.x=d+g.x,i.y=c+g.y),o.processing.buffer.push([p,AmCharts.extend({},i)]),c&&d?i=h:i.y+=c?0:u.offsetHeight,"absolute"==u.style.position&&"amChartsLegend"==u.getAttribute("class")&&(g.y+=u.parentNode.offsetHeight)}n.id=AmCharts.getUniqueId(),n.width=o.chart.divRealWidth,n.height=o.chart.divRealHeight,o.chart.legend&&"outside"==o.chart.legend.position&&(-1!=["left","right"].indexOf(o.cfg.legendPosition)?n.width+=o.chart.legend.div.offsetWidth:"object"==typeof o.cfg.legendPosition?(n.width+=o.cfg.legendPosition.width,n.height+=o.cfg.legendPosition.height):n.height+=o.chart.legend.div.offsetHeight);var m={width:!1,height:!1};return o.chart.periodSelector&&(-1!=["left","right"].indexOf(o.chart.periodSelector.position)?(n.width-=o.chart.periodSelector.div.offsetWidth+16,m.width=!0):(n.height-=o.chart.periodSelector.div.offsetHeight,m.height=!0)),o.chart.dataSetSelector&&(-1!=["left","right"].indexOf(o.chart.dataSetSelector.position)?m.width||(n.width-=o.chart.dataSetSelector.div.offsetWidth+16):n.height-=o.chart.dataSetSelector.div.offsetHeight),(t.backgroundColor||"image/jpeg"==t.format)&&(a.fillStyle=t.backgroundColor||"#FFFFFF",a.fillRect(0,0,n.width,n.height)),function r(){var i,s,l,g;if(o.processing.buffer.length==o.processing.drawn||"svg"==t.format)return e();s=o.processing.buffer[o.processing.drawn],g=(new XMLSerializer).serializeToString(s[0]),l=s[1],"browser"==t.render?((i=new Image).id=AmCharts.getUniqueId(),g="data:image/svg+xml;base64,"+btoa(g),i.onload=function(){a.drawImage(this,s[1].x,s[1].y),o.processing.drawn++,r()},i.onerror=function(){a.drawImage(this,s[1].x,s[1].y),o.processing.drawn++,r()},i.src=g,(i.complete||void 0===i.complete||void 0===i.complete)&&(i.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==",i.src=g)):"canvg"==t.render&&canvg(n,g,{offsetX:l.x,offsetY:l.y,ignoreMouse:!0,ignoreAnimation:!0,ignoreDimensions:!0,ignoreClear:!0,renderCallback:function(){o.processing.drawn++,r()}})}()},generateButtons:function(){var t,e=this;e.div?(t=e.div).innerHTML="":(t=document.createElement("div"),e.div=t),t.setAttribute("style","position: absolute;top:"+e.cfg.menuTop+";right:"+e.cfg.menuRight+";bottom:"+e.cfg.menuBottom+";left:"+e.cfg.menuLeft+";"),t.setAttribute("class","amExportButton"),t.appendChild(function t(o){var r=document.createElement("ul");r.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var n=0;n<o.length;n++){var a=document.createElement("li"),i=document.createElement("img"),s=document.createElement("a"),l=o[n],g=null,u=AmCharts.extend(AmCharts.extend({},e.cfg.menuItemStyle),o[n]);(l=AmCharts.extend(AmCharts.extend({},e.cfg.menuItemOutput),l)).icon&&(i.alt="",i.src=l.icon,i.setAttribute("style","margin: 0 auto;border: none;outline: none"),l.iconTitle&&(i.title=l.iconTitle),s.appendChild(i)),s.href="#",l.title&&(i.setAttribute("style","margin: 0px 5px;"),s.innerHTML+=l.title),s.setAttribute("style","display: block;"),AmCharts.extend(s.style,u),s.onclick=l.onclick.bind(s,e,l),a.appendChild(s),l.items&&(g=t(l.items),a.appendChild(g),a.onmouseover=function(){g.style.display="block"},a.onmouseout=function(){g.style.display="none"},g.style.display="none"),r.appendChild(a),s.onmouseover=function(){this.style.backgroundColor=u.rollOverBackgroundColor,this.style.color=u.rollOverColor,this.style.borderColor=u.rollOverBorderColor},s.onmouseout=function(){this.style.backgroundColor=u.backgroundColor,this.style.color=u.color,this.style.borderColor=u.borderColor}}return 0,r}(e.cfg.menuItems)),e.chart.containerDiv.appendChild(t)}});